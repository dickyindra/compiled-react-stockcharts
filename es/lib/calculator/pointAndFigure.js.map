{"version":3,"sources":["../../../../src/lib/calculator/pointAndFigure.js"],"names":["isNotDefined","PointAndFigure","defaultOptions","createBox","d","dateAccessor","dateMutator","box","open","fromDate","toDate","startOfYear","startOfQuarter","startOfMonth","startOfWeek","updateColumns","columnData","forEach","boxes","eachBox","close","high","Math","max","low","min","date","options","calculator","rawData","reversal","boxSize","sourcePath","source","pricingMethod","column","push","volume","length","upwardMovement","downwardMovement","abs","direction","noOfBoxes","floor","i","prevBoxClose","x","arguments"],"mappings":"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","file":"pointAndFigure.js","sourcesContent":["\r\n\r\nimport { isNotDefined } from \"../utils\";\r\nimport { PointAndFigure as defaultOptions } from \"./defaultOptionsForComputation\";\r\n\r\nfunction createBox(d, dateAccessor, dateMutator) {\r\n\tconst box = {\r\n\t\topen: d.open,\r\n\t\tfromDate: dateAccessor(d),\r\n\t\ttoDate: dateAccessor(d),\r\n\t\tstartOfYear: d.startOfYear,\r\n\t\tstartOfQuarter: d.startOfQuarter,\r\n\t\tstartOfMonth: d.startOfMonth,\r\n\t\tstartOfWeek: d.startOfWeek\r\n\t};\r\n\tdateMutator(box, dateAccessor(d));\r\n\treturn box;\r\n}\r\n\r\nfunction updateColumns(columnData, dateAccessor, dateMutator) {\r\n\tcolumnData.forEach(function(d) {\r\n\t\t// var lastBox = d.boxes[d.boxes.length - 1];\r\n\r\n\t\td.startOfYear = false;\r\n\t\td.startOfQuarter = false;\r\n\t\td.startOfMonth = false;\r\n\t\td.startOfWeek = false;\r\n\r\n\t\td.boxes.forEach(function(eachBox) {\r\n\t\t\tif (isNotDefined(d.open)) d.open = eachBox.open;\r\n\t\t\td.close = eachBox.close;\r\n\t\t\td.high = Math.max(d.open, d.close);\r\n\t\t\td.low = Math.min(d.open, d.close);\r\n\r\n\t\t\tif (isNotDefined(d.fromDate)) d.fromDate = eachBox.fromDate;\r\n\t\t\tif (isNotDefined(d.date)) d.date = eachBox.date;\r\n\t\t\td.toDate = eachBox.toDate;\r\n\r\n\t\t\tif (eachBox.startOfYear) {\r\n\t\t\t\td.startOfYear = d.startOfYear || eachBox.startOfYear;\r\n\t\t\t\td.startOfQuarter = eachBox.startOfQuarter;\r\n\t\t\t\td.startOfMonth = eachBox.startOfMonth;\r\n\t\t\t\td.startOfWeek = eachBox.startOfWeek;\r\n\r\n\t\t\t\tdateMutator(d, dateAccessor(eachBox));\r\n\t\t\t}\r\n\t\t\tif (d.startOfQuarter !== true && eachBox.startOfQuarter) {\r\n\t\t\t\td.startOfQuarter = eachBox.startOfQuarter;\r\n\t\t\t\td.startOfMonth = eachBox.startOfMonth;\r\n\t\t\t\td.startOfWeek = eachBox.startOfWeek;\r\n\t\t\t\t// d.displayDate = eachBox.displayDate;\r\n\t\t\t\tdateMutator(d, dateAccessor(eachBox));\r\n\t\t\t}\r\n\t\t\tif (d.startOfMonth !== true && eachBox.startOfMonth) {\r\n\t\t\t\td.startOfMonth = eachBox.startOfMonth;\r\n\t\t\t\td.startOfWeek = eachBox.startOfWeek;\r\n\t\t\t\t// d.displayDate = eachBox.displayDate;\r\n\t\t\t\tdateMutator(d, dateAccessor(eachBox));\r\n\t\t\t}\r\n\t\t\tif (d.startOfWeek !== true && eachBox.startOfWeek) {\r\n\t\t\t\td.startOfWeek = eachBox.startOfWeek;\r\n\t\t\t\t// d.displayDate = eachBox.displayDate;\r\n\t\t\t\tdateMutator(d, dateAccessor(eachBox));\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t});\r\n\r\n\t// console.table(columnData);\r\n\t// console.table(rawData);\r\n\treturn columnData;\r\n}\r\n\r\n\r\nexport default function() {\r\n\tlet options = defaultOptions;\r\n\tlet dateAccessor = d => d.date;\r\n\tlet dateMutator = (d, date) => { d.date = date; };\r\n\r\n\tfunction calculator(rawData) {\r\n\t\tconst { reversal, boxSize, sourcePath } = options;\r\n\r\n\t\tconst source = sourcePath === \"high/low\"\r\n\t\t\t? d => { return { high: d.high, low: d.low }; }\r\n\t\t\t: d => { return { high: d.close, low: d.close }; };\r\n\r\n\r\n\t\tconst pricingMethod = source;\r\n\t\tconst columnData = [];\r\n\r\n\t\tlet column = {\r\n\t\t\t\tboxes: [],\r\n\t\t\t\topen: rawData[0].open\r\n\t\t\t}, box = createBox(rawData[0], dateAccessor, dateMutator);\r\n\r\n\t\tcolumnData.push(column);\r\n\r\n\t\trawData.forEach(function(d) {\r\n\t\t\tcolumn.volume = (column.volume || 0) + d.volume;\r\n\r\n\t\t\tif (!box.startOfYear) {\r\n\t\t\t\tbox.startOfYear = d.startOfYear;\r\n\t\t\t\tif (box.startOfYear) {\r\n\t\t\t\t\tdateMutator(box, dateAccessor(d));\r\n\t\t\t\t\t// box.displayDate = d.displayDate;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (!box.startOfYear && !box.startOfQuarter) {\r\n\t\t\t\tbox.startOfQuarter = d.startOfQuarter;\r\n\t\t\t\tif (box.startOfQuarter && !box.startOfYear) {\r\n\t\t\t\t\tdateMutator(box, dateAccessor(d));\r\n\t\t\t\t\t// box.displayDate = d.displayDate;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (!box.startOfQuarter && !box.startOfMonth) {\r\n\t\t\t\tbox.startOfMonth = d.startOfMonth;\r\n\t\t\t\tif (box.startOfMonth && !box.startOfQuarter) {\r\n\t\t\t\t\tdateMutator(box, dateAccessor(d));\r\n\t\t\t\t\t// box.displayDate = d.displayDate;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t\tif (!box.startOfMonth && !box.startOfWeek) {\r\n\t\t\t\tbox.startOfWeek = d.startOfWeek;\r\n\t\t\t\tif (box.startOfWeek && !box.startOfMonth) {\r\n\t\t\t\t\tdateMutator(box, dateAccessor(d));\r\n\t\t\t\t\t// box.displayDate = d.displayDate;\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tif (columnData.length === 1 && column.boxes.length === 0) {\r\n\t\t\t\tconst upwardMovement = (Math.max((pricingMethod(d).high - column.open), 0)); // upward movement\r\n\t\t\t\tconst downwardMovement = Math.abs(Math.min((column.open - pricingMethod(d).low), 0)); // downward movement\r\n\t\t\t\tcolumn.direction = upwardMovement > downwardMovement ? 1 : -1;\r\n\t\t\t\tif (boxSize * reversal < upwardMovement\r\n\t\t\t\t\t|| boxSize * reversal < downwardMovement) {\r\n\t\t\t\t\t// enough movement to trigger a reversal\r\n\t\t\t\t\tbox.toDate = dateAccessor(d);\r\n\t\t\t\t\tbox.open = column.open;\r\n\t\t\t\t\tconst noOfBoxes = column.direction > 0\r\n\t\t\t\t\t\t? Math.floor(upwardMovement / boxSize)\r\n\t\t\t\t\t\t: Math.floor(downwardMovement / boxSize);\r\n\t\t\t\t\tfor (let i = 0; i < noOfBoxes; i++) {\r\n\t\t\t\t\t\tbox.close = box.open + column.direction * boxSize;\r\n\t\t\t\t\t\tconst prevBoxClose = box.close;\r\n\t\t\t\t\t\tcolumn.boxes.push(box);\r\n\t\t\t\t\t\tbox = createBox(box, dateAccessor, dateMutator);\r\n\t\t\t\t\t\t// box = cloneMe(box);\r\n\t\t\t\t\t\tbox.open = prevBoxClose;\r\n\t\t\t\t\t}\r\n\t\t\t\t\tbox.fromDate = dateAccessor(d);\r\n\t\t\t\t\tbox.date = dateAccessor(d);\r\n\t\t\t\t}\r\n\t\t\t} else {\r\n\t\t\t\t// one or more boxes already formed in the current column\r\n\t\t\t\tconst upwardMovement = (Math.max((pricingMethod(d).high - box.open), 0)); // upward movement\r\n\t\t\t\tconst downwardMovement = Math.abs(Math.min((pricingMethod(d).low - box.open), 0)); // downward movement\r\n\r\n\t\t\t\tif ((column.direction > 0 && upwardMovement > boxSize) /* rising column AND box can be formed */\r\n\t\t\t\t\t\t|| (column.direction < 0 && downwardMovement > boxSize) /* falling column AND box can be formed */ ) {\r\n\t\t\t\t\t// form another box\r\n\t\t\t\t\tbox.close = box.open + column.direction * boxSize;\r\n\t\t\t\t\tbox.toDate = dateAccessor(d);\r\n\t\t\t\t\tconst prevBoxClose = box.close;\r\n\t\t\t\t\tcolumn.boxes.push(box);\r\n\t\t\t\t\tbox = createBox(d, dateAccessor, dateMutator);\r\n\t\t\t\t\tbox.open = prevBoxClose;\r\n\t\t\t\t\tbox.fromDate = dateAccessor(d);\r\n\t\t\t\t\tdateMutator(box, dateAccessor(d));\r\n\t\t\t\t} else if ((column.direction > 0 && downwardMovement > boxSize * reversal) /* rising column and there is downward movement to trigger a reversal */\r\n\t\t\t\t\t\t|| (column.direction < 0 && upwardMovement > boxSize * reversal)/* falling column and there is downward movement to trigger a reversal */) {\r\n\t\t\t\t\t// reversal\r\n\r\n\t\t\t\t\tbox.open = box.open + -1 * column.direction * boxSize;\r\n\t\t\t\t\tbox.toDate = dateAccessor(d);\r\n\t\t\t\t\t// box.displayDate = d.displayDate;\r\n\t\t\t\t\tdateMutator(box, dateAccessor(d));\r\n\t\t\t\t\t// box.startOfYear = d.startOfYear;\r\n\t\t\t\t\t// box.startOfQuarter = d.startOfQuarter;\r\n\t\t\t\t\t// box.startOfMonth = d.startOfMonth;\r\n\t\t\t\t\t// box.startOfWeek = d.startOfWeek;\r\n\t\t\t\t\t// console.table(column.boxes);\r\n\t\t\t\t\t// var idx = index + 1;\r\n\t\t\t\t\tcolumn = {\r\n\t\t\t\t\t\tboxes: [],\r\n\t\t\t\t\t\tvolume: 0,\r\n\t\t\t\t\t\tdirection: -1 * column.direction\r\n\t\t\t\t\t};\r\n\t\t\t\t\tconst noOfBoxes = column.direction > 0\r\n\t\t\t\t\t\t? Math.floor(upwardMovement / boxSize)\r\n\t\t\t\t\t\t: Math.floor(downwardMovement / boxSize);\r\n\t\t\t\t\tfor (let i = 0; i < noOfBoxes; i++) {\r\n\t\t\t\t\t\tbox.close = box.open + column.direction * boxSize;\r\n\t\t\t\t\t\tconst prevBoxClose = box.close;\r\n\t\t\t\t\t\tcolumn.boxes.push(box);\r\n\t\t\t\t\t\tbox = createBox(d, dateAccessor, dateMutator);\r\n\t\t\t\t\t\tbox.open = prevBoxClose;\r\n\t\t\t\t\t}\r\n\r\n\t\t\t\t\tcolumnData.push(column);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t});\r\n\t\tupdateColumns(columnData, dateAccessor, dateMutator);\r\n\r\n\t\treturn columnData;\r\n\t}\r\n\tcalculator.options = function(x) {\r\n\t\tif (!arguments.length) {\r\n\t\t\treturn options;\r\n\t\t}\r\n\t\toptions = { ...defaultOptions, ...x };\r\n\t\treturn calculator;\r\n\t};\r\n\tcalculator.dateMutator = function(x) {\r\n\t\tif (!arguments.length) return dateMutator;\r\n\t\tdateMutator = x;\r\n\t\treturn calculator;\r\n\t};\r\n\tcalculator.dateAccessor = function(x) {\r\n\t\tif (!arguments.length) return dateAccessor;\r\n\t\tdateAccessor = x;\r\n\t\treturn calculator;\r\n\t};\r\n\r\n\treturn calculator;\r\n}\r\n"]}